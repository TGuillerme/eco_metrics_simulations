---
title: "Testing empirical trait space increase"
output:
  html_document: default
  pdf_document: default
---

# Loading the traitspace and the groups

```{r}
library(dispRity)
library(knitr)
## global trait space 
empirical_traitspace <- read.csv('../Data/Raw/trait-space-5d-prehistoric-community.csv', row.names = 1) 

## Species lists
# prehistoric_species <- rownames(read.csv("../Data/Raw/prehistoric-species-list.csv"))
historic_species <- rownames(read.csv('../Data/Raw/historic-species-list-minus-a-flammeus.csv', row.names = 1))
extant_species <- rownames(read.csv('../Data/Raw/present-species-list-minus-a-flammeus.csv', row.names = 1))

## Traitspace groups
extant_group <- rownames(empirical_traitspace) %in% extant_species ## 37 species present
historic_group <- rownames(empirical_traitspace) %in% historic_species ## 63 species present
groups <- list("extant" = extant_group, "historic" = historic_group)
```

# Creating the groups and visualising the space

```{r}
## Creating the subsets
custom_groups <- lapply(groups, which)
custom_groups$all <- 1:nrow(empirical_traitspace)
grouped_space <- custom.subsets(empirical_traitspace, group = custom_groups)
```

```{r, fig.height = 8, fig.width = 8}
## Visualising the traitspace (you can also just use: plot(grouped_space)!)
plot(empirical_traitspace[, c(1,2)], pch = 19, col = "darkgreen", xlim = c(-4,6.5), ylim = c(-6.5, 4), xlab = "PC1 (79.11%)", ylab = "PC2 (7.81%)", cex = 1.5)
points(empirical_traitspace[custom_groups$historic, c(1,2)], pch = 19, col = "lightblue", cex = 1.25)
points(empirical_traitspace[custom_groups$extant, c(1,2)], pch = 19, col = "orange", cex = 0.9)
legend("bottomright", legend = c("all (prehist)", "historic", "extant"), pch = 19, col = c("darkgreen", "lightblue", "orange"))
```

```{r, fig.height = 8, fig.width = 8}
## Visualising the space in n_dimensionss
col_groups <- rep("darkgreen", nrow(empirical_traitspace))
col_groups[custom_groups$historic] <- "lightblue"
col_groups[custom_groups$extant] <- "orange"
plot(empirical_traitspace, col = col_groups, pch = 19)
```

# Measuring disparity

## Functional divergence (Villeger 2009)

The rarefaction here is for checking any potential sample size effect:

```{r}
summary(dispRity(boot.matrix(grouped_space, rarefaction = 37), metric = func.div))
```

So here we have `prehistoric < historic < extant` i.e. and increase in functional divergence through time.

## pseudo half hyperperimeter

We can then check using the metric `c(sum, quantiles)` which is the sum of the spread of the 95% quantile i.e. the sum of the spread on each dimensions without potential outliers.
The two times the sum of lengths is the perimeter of a parallelepiped so here we have the "pseudo semi hyperperimeter" or something like that?

```{r}
summary(dispRity(boot.matrix(grouped_space, rarefaction = 37), metric = c(sum, quantiles)))
```

Using this we have `prehistoric > historic > extant`, i.e. a decrease in trait space occupancy through time.

# Testing the metrics

This basically requires us to actually test what we mean by changes in traitspace occupancy through time.
For example, when we mean functional divergence, what do we expect this to capture in terms of size, position, density, etc. of the traitspace?
Let's test both in terms of traitspace size, just for the example:

## Functional divergence

```{r}
## Testing the functional divergence
func_div_test <- test.metric(grouped_space, metric = func.div, shifts = c("random", "size"), replicates = 30)
```

The results for the functional divergence tests:
```{r, echo = FALSE}
kable(summary(func_div_test))
```

The visualisation of the results:
```{r, echo = FALSE, fig.height = 12, fig.width = 6}
plot(func_div_test)
```

If we just focus on changes of the traitspace size, we see that the relationship between this metric and the changes in traitspace size are not linear which might explain the difficulties in interpretations!
First, we see that the random removal is actually good: the metric does not change on average when removing random number of elements (the flat slope on the first plot).

Then, when looking at size increase (orange slope), we see an actual gradual decrease of the metric with the amount of data. The more data, the smaller the functional divergence (this is what we actually have in our empirical example!).
When looking at hollowness (blue slope - the whole left in the traitspace when removing data), the relationship with amounts of data and functional divergence is quiet funky and non linear!

## pseudo half hyperperimeter

```{r}
## Testing the sum of quantiles
sum_quant_test <- test.metric(grouped_space, metric = c(sum, quantiles),  shifts = c("random", "size"), replicates = 30)
```

The results for the sum of the quantiles tests:
```{r, echo = FALSE}
kable(summary(sum_quant_test))
```

The visualisation of the results:
```{r, echo = FALSE, fig.height = 12, fig.width = 6}
plot(sum_quant_test)
```

For the sum of quantiles, we have something worse going on here.
When looking at just the random changes, there is an increase of metric through time, so basically it's gonna be hard to say if this metric picks up meaningful changes in traitspace or random ones.

## median distances from the centroids

A third alternative could be to use the mediand distances from each groups' centroid: this one seem more intuitive, at least for the size increase.

```{r}
plot(test.metric(grouped_space, metric = c(median, centroids),  shifts = c("random", "size"), replicates = 10))
```